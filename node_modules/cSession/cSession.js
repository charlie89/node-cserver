var cSettings = require('cSettings');
var db = require('mongoskin').db(cSettings.db);
var cookies = require('cookies');
var keys = require("keygrip")([ "SEKRIT2", "SEKRIT1" ]);

var dataPool = {
   _pool: [],

   set: function(name, data) {
      if (name === 'undefined') {
         console.error("dataPool: ERROR: name = 'undefined'");
         return;
      }
      this._pool[name] = data;
   },

   get: function(name) {
      if (typeof(this._pool[name]) !== "undefined") {
         return this._pool[name];
      }
      return false;
   }
};

function tryLogin(req, res, name, pw, cookie) {
   console.log("try logging in: " + name);
   db.collection('users').findOne({
      'name': name
   }, function(err, user) {
      if (err || !user || user.pw !== pw) {
         console.log("Login failed: " + name + "@" + pw + " err:" + JSON.stringify(err));
         if (res) res.end("ERROR");
      }
      else {
         user.id = user._id + '';  //make id to string, otherwise filtering for it fails
         dataPool.set(name, user);
         if (req)
         {
            cookie.set('cweb', name, {
               signed: true
            });

            res.end("OK");
         }
         console.log("Login success: " + name);
      }
   });
}

module.exports = function(req, res, next){
   //		sesh(req, res, function(req, res){
   //			// auto log in on development
   //			if ((cSettings.debug === true) && (req.session.data.user === 'Guest')) {
   //				req.session.data.user = cSettings.debugConf.autoLogin.name;
   //			}
   // get user data
   //         console.log('User:' + req.session.data.user);,

   var cookie = new cookies( req, res, keys );

   req.user = dataPool.get(cSettings.debug === true ?
      cSettings.debugConf.autoLogin.name : cookie.get('cweb', {
         signed: true
      }));
   if (!req.user){
      if (require("url").parse(req.url).pathname == "/login") {
         res.writeHead(307, {
            'Location': "/login"
         });
      } else {
         // check name and pw
         var query = require("url").parse(req.url, true).query;
         if (typeof query.name !== 'undefined') {
            tryLogin(req, res, query.name, query.pw, cookie);
         } else {
            require("fs").readFile(__dirname + '/../../client/views/login.html', function(err, data) {
               if (err) throw err;
               res.end(data);
            });
         }
      }
   }
   else
      next(req, res);

}

if (cSettings.debug === true) {
   tryLogin(null, null, cSettings.debugConf.autoLogin.name, cSettings.debugConf.autoLogin.pw);
}
